# AggregationService

## Введение

Тестовое задание для Junior Golang Developer (Effective Mobile).

REST-сервис для агрегации данных об онлайн-подписках пользователей.

---

## Задача

Реализовать сервис, который позволяет:

- Создавать, читать, обновлять, удалять и получать список подписок (CRUDL).
- Каждая подписка содержит:
    - Название сервиса
    - Стоимость месячной подписки (целое число рублей)
    - ID пользователя (UUID)
    - Дата начала (месяц и год)
    - Опционально — дата окончания
- Получать суммарную стоимость всех подписок за выбранный период, с фильтрацией по пользователю и названию сервиса.

---

## Требования к реализации

- Язык: Go 1.24+
- СУБД: PostgreSQL
- Миграции для инициализации базы данных (папка `internal/migrations`)
- Логирование через slog (уровень настраивается через ENV)
- Конфигурация через `.env`-файл
- Swagger-документация (`/swagger/`)
- Запуск сервиса и базы через Docker Compose

---

## Настройка

1. **Создайте файл `.env` в корне проекта**  
   (пример — см. `.env.example`):

   ```
   PG_DRIVER=
   PG_DSN=
   POSTGRES_USER=
   POSTGRES_PASSWORD=
   POSTGRES_DB=
   SERVER_PORT=
   ENV=
   ```

2. **Запустите сервис и базу:**
   ```sh
   make up
   ```

3. **Swagger-документация доступна по адресу:**
   ```
   http://localhost:7071/swagger/
   ```

4. **Миграции применяются автоматически при старте.**

---

## Логи

- Два режима логирования:
    - DEV — уровень DEBUG
    - PROD — уровень INFO
- Меняется через переменную `ENV` в `.env`.

---

## Тесты

- Для запуска unit-тестов:
  ```sh
  make test
  ```
- Покрытие: unit-тесты для бизнес-логики и хэндлеров, а также тесты репозитория с реальной базой.

---

## API

### CRUDL для подписок

- `POST /subscriptions` — создать подписку
- `GET /subscriptions` — получить список подписок (фильтры: user_id, service_name, start_date, end_date)
- `GET /subscriptions/{id}` — получить подписку по ID
- `PUT /subscriptions/{id}` — обновить подписку
- `DELETE /subscriptions/{id}` — удалить подписку

#### Пример запроса на создание:

```json
{
  "service_name": "Yandex Plus",
  "price": 400,
  "user_id": "60601fee-2bf1-4721-ae6f-7636e79a0cba",
  "start_date": "07-2025"
}
```

### Подсчёт стоимости

- `GET /subscriptions/cost` — получить суммарную стоимость подписок за период  
  (фильтры: user_id, service_name, start_date, end_date)

---

## Миграции

- Все миграции для PostgreSQL лежат в папке `internal/migrations`.
- Применяются автоматически при запуске через docker-compose.

---

## Swagger

- Описание API доступно по `/swagger/` после запуска сервиса.

---

## Примечания

- Проверка существования пользователя не требуется.
- Управление пользователями вне зоны ответственности сервиса.
- Стоимость подписки — только целое число рублей.

---

## Возможные вопросы

### Почему именно такая архитектура?

Было решено использовать гексагональную архитектуру. Это облегчает тестирование и расширение функционала.

### Почему тестов не так много?

В целях экономии времени покрыта основная бизнес-логика, хэндлеры и репозиторий, чего хватит для минимальной проверки работоспособности приложения.

### Что можно улучшить?

- Добавить больше интеграционных тестов
- Улучшить документацию
- Улучшить качество логирования